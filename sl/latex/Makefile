
sources = intro-sl.tex arrays-sl.tex linkedlists-sl.tex skiplists-sl.tex \
	hashing-sl.tex binarytrees-sl.tex rbs-sl.tex scapegoat-sl.tex redblack-sl.tex \
	heaps-sl.tex sorting-sl.tex graphs-sl.tex integers-sl.tex btree-sl.tex
javs = $(sources:.tex=-java.tex)
javh = $(sources:.tex=-java-html.tex)
cpps = $(sources:.tex=-cpp.tex)
cpph = $(sources:.tex=-cpp-html.tex)
java = $(wildcard ../java/ods/*.java)
cppsource = $(wildcard ../cpp/*.h)
pdfs = ods-sl-java.pdf ods-sl-cpp.pdf
styles=ods.sty ods-colors.sty

LFLAGS=-interaction=nonstopmode -halt-on-error

all: $(pdfs)

.PHONY: all figs images install clean

figs:
	cd figs ; make

epsfigs:
	cd figs ; make epss

images:
	cd images ; make

check-compilable: ods-sl-java.tex $(javs) $(styles) images figs
	pdflatex -halt-on-error ods-sl-java

ods-sl-java.pdf : ods-sl-java.tex $(javs) $(styles) images figs
	latexmk -pdf ods-sl-java

ods-sl-java.tex : ods-sl.tex Makefile
	echo "%%%\n%%% Autogenerated file - do not edit \n%%%" | cat - ods-sl.tex \
		| sed 's/-lang/-java/' > ods-sl-java.tex
	sed -i 's/%HEADCOMMAND/\\newcommand{\\cpponly}[1]{}\\newcommand{\\javaonly}[1]{#1}\\newcommand{\\lang}{Java}/' ods-sl-java.tex

ods-sl-cpp.pdf : ods-sl-cpp.tex $(cpps) $(styles) images figs
	latexmk -pdf ods-sl-cpp

ods-sl-cpp.tex : ods-sl.tex Makefile
	echo "%%%\n%%% Autogenerated file - do not edit \n%%%" | cat - ods-sl.tex \
		| sed 's/-lang/-cpp/' > ods-sl-cpp.tex
	sed -i 's/%HEADCOMMAND/\\newcommand{\\javaonly}[1]{}\\newcommand{\\cpponly}[1]{#1}\\newcommand{\\lang}{C++}/' ods-sl-cpp.tex

%-java.tex : %.tex $(java) snarf-java.pl Makefile
	echo "%%%\n%%% Autogenerated file - do not edit \n%%%" | cat - $< \
		| ./snarf-java.pl > $*-java.tex 

%-cpp.tex : %.tex $(cppsource) snarf-cpp.pl Makefile
	echo "%%%\n%%% Autogenerated file - do not edit \n%%%" | cat - $< \
		| ./snarf-cpp.pl > $*-cpp.tex 

install-pdf : ods-sl-java.pdf ods-sl-cpp.pdf ods-sl-java-grayscale.pdf ods-sl-cpp-grayscale.pdf ods-sl-java-screen.pdf ods-sl-cpp-screen.pdf
#	scp -r ods-sl-java.pdf ods-sl-java-grayscale.pdf ods-sl-cpp.pdf ods-sl-cpp-grayscale.pdf ods-sl-java-screen.pdf ods-sl-cpp-screen.pdf ods-book.css morin@cg.scs.carleton.ca:public_html/ods/

install : ods-sl-java.pdf ods-sl-cpp.pdf ods-sl-java-grayscale.pdf ods-sl-cpp-grayscale.pdf sl-java-html sl-cpp-html
#	scp -r  ods-sl-java/ ods-sl-java.pdf ods-sl-java-grayscale.pdf ods-sl-cpp/ ods-sl-cpp.pdf ods-sl-cpp-grayscale.pdf ods-book.css morin@cg.scs.carleton.ca:public_html/ods/

clean:
	rm -f $(javs) $(cpps) $(javh) $(cpph) *.log *.bbl *.out ods-sl.toc $(pdfs) 
	rm -rf ods-sl-java/ ods-sl-cpp/
	cd figs; make clean
	cd images; make clean

# A dirty hack for getting a grayscale file
%-grayscale.pdf : %.pdf
	gs -sOutputFile=$@ -sDEVICE=pdfwrite \
	-sColorConversionStrategy=Gray -dProcessColorModel=/DeviceGray \
	-dCompatibilityLevel=1.4 $< < /dev/null

# Lots of hackery for generating html using latex2html
html: java-sl-html cpp-sl-html

sl-java-html : $(javh) ods-sl-java-html.tex epsfigs
	mkdir -p ods-sl-java
	pdflatex ods-sl-java-html
	bibtex ods-sl-java-html
	latex2html -init_file latex2html-init -dir ods-sl-java ods-sl-java-html
	
ods-sl-java-html.tex : ods-sl.tex Makefile
	sed 's/-lang/-java-html/' ods-sl.tex > ods-sl-java-html.tex
	sed -i 's/%HEADCOMMAND/\\newcommand{\\cpponly}[1]{}\\newcommand{\\javaonly}[1]{#1}\\newcommand{\\lang}{Java}/' ods-sl-java-html.tex
	sed -i 's/\\include{cpp-preface}//' ods-sl-java-html.tex

%-java-html.tex : %.tex $(java) snarf-java-html.pl Makefile
	cat $< | ./snarf-java-html.pl > $*-java-html.tex 

sl-cpp-html : $(cpph) ods-sl-cpp-html.tex epsfigs
	mkdir -p ods-sl-cpp
	pdflatex ods-sl-cpp-html
	bibtex ods-sl-cpp-html
	latex2html -init_file latex2html-init -dir ods-sl-cpp ods-sl-cpp-html
	
ods-cpp-html.tex : ods-sl.tex Makefile
	sed 's/-lang/-cpp-html/' ods-sl.tex > ods-sl-cpp-html.tex
	sed -i 's/%HEADCOMMAND/\\newcommand{\\javaonly}[1]{}\\newcommand{\\cpponly}[1]{#1}\\newcommand{\\lang}{C++}/' ods-sl-cpp-html.tex

%-cpp-html.tex : %.tex $(cpp) snarf-cpp-html.pl Makefile
	cat $< | ./snarf-cpp-html.pl > $*-cpp-html.tex 

ods-sl-java-screen.pdf : ods-sl-java.pdf
	gs -o ods-sl-java-screen.pdf -sDEVICE=pdfwrite -c "[/CropBox [53 88 379 595] /PAGES pdfmark" -f ods-sl-java.pdf

ods-sl-cpp-screen.pdf : ods-sl-cpp.pdf
	gs -o ods-sl-cpp-screen.pdf -sDEVICE=pdfwrite -c "[/CropBox [53 88 379 595] /PAGES pdfmark" -f ods-sl-cpp.pdf


